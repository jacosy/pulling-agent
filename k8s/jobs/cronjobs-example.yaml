---
# ConfigMap-based CronJobs (Legacy/Single-Pod Method)
#
# NOTE: For distributed control of ALL workers, use worker-cronjobs.yaml instead.
# This file controls individual pods via ConfigMap (requires RBAC).
#
# Distributed Control (Recommended):
#   - Use: k8s/jobs/worker-cronjobs.yaml
#   - Method: HTTP API (/api/worker/*)
#   - Controls: ALL workers at once
#
# ConfigMap Control (This File):
#   - Method: ConfigMap updates
#   - Controls: Individual pods only
#   - Requires: RBAC permissions
#
---
# CronJob to pause agent during maintenance window (ConfigMap method)
# Example: Pause every day at 2 AM UTC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pause-agent-maintenance-configmap
  labels:
    app: pulling-agent-control
    operation: scheduled-pause
    method: configmap
spec:
  schedule: "0 2 * * *"  # Every day at 2 AM UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: pulling-agent-control
        operation: pause
    spec:
      ttlSecondsAfterFinished: 3600  # Delete after 1 hour
      template:
        metadata:
          labels:
            app: pulling-agent-control
        spec:
          restartPolicy: Never
          serviceAccountName: agent-controller
          containers:
          - name: pause
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              echo "Scheduled pause: Maintenance window started"
              kubectl create configmap agent-control \
                --from-literal=state=pause \
                -o yaml --dry-run=client | kubectl apply -f -
              echo "Agent paused at $(date)"

---
# CronJob to resume agent after maintenance window (ConfigMap method)
# Example: Resume every day at 4 AM UTC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: resume-agent-maintenance-configmap
  labels:
    app: pulling-agent-control
    operation: scheduled-resume
    method: configmap
spec:
  schedule: "0 4 * * *"  # Every day at 4 AM UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: pulling-agent-control
        operation: resume
    spec:
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app: pulling-agent-control
        spec:
          restartPolicy: Never
          serviceAccountName: agent-controller
          containers:
          - name: resume
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              echo "Scheduled resume: Maintenance window ended"
              kubectl create configmap agent-control \
                --from-literal=state=resume \
                -o yaml --dry-run=client | kubectl apply -f -
              echo "Agent resumed at $(date)"

---
# Example: Pause during business hours, resume outside business hours (ConfigMap method)
# Pause at 9 AM on weekdays
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pause-agent-business-hours-configmap
  labels:
    app: pulling-agent-control
    method: configmap
spec:
  schedule: "0 9 * * 1-5"  # 9 AM, Monday-Friday
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          serviceAccountName: agent-controller
          containers:
          - name: pause
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              kubectl create configmap agent-control \
                --from-literal=state=pause \
                -o yaml --dry-run=client | kubectl apply -f -

---
# Resume at 6 PM on weekdays (ConfigMap method)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: resume-agent-off-hours-configmap
  labels:
    app: pulling-agent-control
    method: configmap
spec:
  schedule: "0 18 * * 1-5"  # 6 PM, Monday-Friday
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          serviceAccountName: agent-controller
          containers:
          - name: resume
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              kubectl create configmap agent-control \
                --from-literal=state=resume \
                -o yaml --dry-run=client | kubectl apply -f -

---
# Notes:
# - All CronJobs use UTC timezone
# - Requires ServiceAccount 'agent-controller' with proper RBAC (see control-jobs.yaml)
# - Customize schedules using cron format: "minute hour day month day-of-week"
# - Common patterns:
#   - "0 2 * * *"       - Every day at 2 AM
#   - "0 9 * * 1-5"     - Weekdays at 9 AM
#   - "*/30 * * * *"    - Every 30 minutes
#   - "0 */4 * * *"     - Every 4 hours
#   - "0 0 * * 0"       - Every Sunday at midnight
